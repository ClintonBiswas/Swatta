{% extends 'base.html' %}
{% block title %}Verify Your Order{% endblock %}

{% block extra_css %}
<style>
    @media (max-width: 991.98px) {
        .email-verify {
            margin-top: 80px;
        }
    }
    .verification-input {
        letter-spacing: 2px;
        font-size: 1.5rem;
        text-align: center;
        padding: 10px;
    }
    .resend-btn {
        min-width: 150px;
    }
    .countdown-display {
        display: inline-block;
        min-width: 50px;
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="d-flex justify-content-center align-items-center py-5 email-verify">
    <div class="card shadow-lg p-4" style="max-width: 500px; width: 100%; background-color: var(--sub-color); border: none;">
        <h2 class="text-center mb-3" style="font-size: 22px; font-weight: 500;">Verify Your Order</h2>
        
            {% if delivery_method == 'sms' %}
            <p class="text-center text-muted">
                We've sent a 6-digit verification code to your phone number: 
                <strong>{{ phone|slice:":3" }}*****{{ phone|slice:"8:" }}</strong>
            </p>
            {% else %}
            <p class="text-center text-muted">
                We've sent a 6-digit verification code to your email: 
                <strong>{{ email }}</strong>
            </p>
            {% endif %}

            <div class="text-center mb-3">
                <small class="text-muted">
                    Please check your {% if delivery_method == 'sms' %}phone{% else %}email{% endif %} and enter the code below
                </small>
            </div>
        
        {% if messages %}
        <div class="message-container">
            {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <form method="POST" class="mt-3">
            {% csrf_token %}
            <div class="form-group mb-4">
                <label for="verification_code" class="form-label">Verification Code</label>
                <input type="text" class="form-control verification-input" id="verification_code" 
                       name="verification_code" placeholder="------"
                       pattern="\d{6}" title="Please enter a 6-digit code"
                       maxlength="6" inputmode="numeric">
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-4">
                <button type="submit" class="btn btn-success px-4 py-2">
                    Confirm Order
                </button>
                
                <button type="submit" name="resend_code" class="btn btn-outline-primary resend-btn {% if cooldown_remaining > 0 %}disabled{% endif %}" 
                    {% if cooldown_remaining > 0 %}disabled title="Please wait before resending"{% endif %}>
                    <span class="resend-text">Resend Code</span>
                    {% if cooldown_remaining > 0 %}
                    <span class="countdown-display">({{ cooldown_remaining }}s)</span>
                    {% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-focus the verification code input
    const codeInput = document.getElementById('verification_code');
    if (codeInput) {
        codeInput.focus();
        
        // Auto-advance between digits
        codeInput.addEventListener('input', function(e) {
            if (this.value.length === 6) {
                this.form.querySelector('button[type="submit"]').focus();
            }
        });
    }

    // Countdown timer for resend button
    let cooldown = parseInt("{{ cooldown_remaining|default:0 }}") || 0;
    const resendBtn = document.querySelector('button[name="resend_code"]');
    const resendText = resendBtn ? resendBtn.querySelector('.resend-text') : null;
    const countdownDisplay = resendBtn ? resendBtn.querySelector('.countdown-display') : null;

    if (cooldown > 0 && resendBtn) {
        const updateCountdown = () => {
            cooldown--;
            
            if (cooldown <= 0) {
                resendBtn.disabled = false;
                resendBtn.classList.remove('disabled');
                if (countdownDisplay) countdownDisplay.textContent = '';
                if (resendText) resendText.textContent = 'Resend Code';
                resendBtn.title = '';
            } else {
                if (countdownDisplay) countdownDisplay.textContent = `(${cooldown}s)`;
                resendBtn.disabled = true;
            }
        };

        // Initial update
        updateCountdown();
        
        // Update every second
        const timer = setInterval(updateCountdown, 1000);
    }
    
    // Auto-submit form when code is complete
    if (codeInput) {
        codeInput.addEventListener('keyup', function(e) {
            if (this.value.length === 6) {
                this.form.submit();
            }
        });
    }
});
</script>
{% endblock extra_js %}