{% load static %}
<script>
!function(f,b,e,v,n,t,s){
  if(f.fbq)return;n=f.fbq=function(){
    n.callMethod ? n.callMethod.apply(n,arguments) : n.queue.push(arguments);
  };
  if(!f._fbq)f._fbq=n;
  n.push=n; n.loaded=!0; n.version='2.0';
  n.queue=[]; t=b.createElement(e); t.async=!0;
  t.src=v; s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s);
}(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');

fbq('init', '{{ FACEBOOK_PIXEL_ID }}');

// ✅ Create event_id for deduplication
const eventId = 'pageview_' + Date.now() + '_' + Math.floor(Math.random() * 1000000);
document.cookie = `fb_event_id=${eventId}; path=/; SameSite=Lax`;

// ✅ Trigger PageView with event_id
fbq('track', 'PageView', {}, { eventID: eventId });

// ✅ Ensure _fbc cookie exists when fbclid param is present
(function() {
  function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? match[2] : null;
  }

  if (!getCookie("_fbc") && window.location.search.includes("fbclid=")) {
    const fbclid = new URLSearchParams(location.search).get("fbclid");
    document.cookie = `_fbc=fb.1.${Date.now()}.${fbclid}; path=/; SameSite=Lax`;
  }
})();
</script>
<script src="{% static 'js/fb-data.js' %}"></script>
