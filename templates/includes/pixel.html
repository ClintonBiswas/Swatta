{% load static %}
<script>
  // User role & Pixel ID from template/context
  window.CURRENT_USER_ROLE = "{{ request.user.is_authenticated|yesno:'logged_in,guest' }}";
  window.FACEBOOK_PIXEL_ID = "{{ FACEBOOK_PIXEL_ID }}";
</script>

<!-- FB Pixel Loader -->
<script>
!function(f,b,e,v,n,t,s){
  if(f.fbq) return;
  n=f.fbq=function(){ n.callMethod? n.callMethod.apply(n,arguments): n.queue.push(arguments) };
  if(!f._fbq) f._fbq=n; n.push=n; n.loaded=!0; n.version='2.0'; n.queue=[];
  t=b.createElement(e); t.async=!0; t.src=v;
  s=b.getElementsByTagName(e)[0]; s.parentNode.insertBefore(t,s);
}(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');

// Initialize Pixel
if(window.FACEBOOK_PIXEL_ID){
  fbq('init', window.FACEBOOK_PIXEL_ID);
}

// Cookie helper
function getCookie(name){
  const m = document.cookie.match(new RegExp("(^| )"+name+"=([^;]+)"));
  return m ? decodeURIComponent(m[2]) : null;
}

// Fire PageView only if server-side didn't already fire it
(function(){
  const pageviewEventId = getCookie("fb_event_id") || null;

  if(!pageviewEventId){
    fbq('track', 'PageView', {
      value: 1.0,
      currency: 'BDT',
      content_ids: [window.location.pathname],
      content_type: 'page',
      content_category: 'PageView',
      event_source_url: window.location.href,
      page_title: document.title,
      action_source: 'website'
    });
    console.log("Browser PageView fired (no server event_id)");
  }else{
    console.log("Server-side PageView already fired, browser skipped:", pageviewEventId);
  }
})();
</script>

<!-- Load your fb-data.js for custom events -->
<script src="{% static 'js/fb-data.js' %}"></script>