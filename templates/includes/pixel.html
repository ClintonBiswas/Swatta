{% load static %}
<script>
  window.CURRENT_USER_ROLE = "{{ request.user.is_authenticated|yesno:'logged_in,guest' }}";
  window.FACEBOOK_PIXEL_ID = "{{ FACEBOOK_PIXEL_ID }}"; // inject from template context or settings
</script>

<!-- FB Pixel loader -->
<script>
  !function(f,b,e,v,n,t,s){
    if(f.fbq) return; n=f.fbq=function(){ n.callMethod? n.callMethod.apply(n,arguments): n.queue.push(arguments) };
    if(!f._fbq) f._fbq=n; n.push=n; n.loaded=!0; n.version='2.0'; n.queue=[];
    t=b.createElement(e); t.async=!0; t.src=v; s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s);
  }(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');

  // initialize (no token / secret here)
  if (window.FACEBOOK_PIXEL_ID) {
    fbq('init', window.FACEBOOK_PIXEL_ID);
  }

  // Helper to read cookie
  function getCookie(name){ const m = document.cookie.match(new RegExp("(^| )"+name+"=([^;]+)")); return m ? decodeURIComponent(m[2]) : null; }

  // Fire PageView using server-saved fb_event_id cookie (if set)
  (function(){
    const pageviewEventId = getCookie("fb_event_id") || null;
    fbq('track', 'PageView', {
      value: 1.0,
      currency: 'BDT',
      content_ids: [window.location.pathname],
      content_type: 'page',
      content_category: 'PageView',
      event_source_url: window.location.href,
      page_title: document.title,
      action_source: 'website'
    }, pageviewEventId ? { eventID: pageviewEventId } : undefined);
    console.log("PageView (Browser) fired with server event_id:", pageviewEventId);
  })();
</script>

<!-- load fb-data.js (below) -->
<script src="{% static 'js/fb-data.js' %}"></script>
